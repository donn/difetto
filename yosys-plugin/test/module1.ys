plugin -i ../difetto.so
read_liberty -ignore_miss_func tech/sky130_fd_sc_hd__tt_025C_1v80.lib
read_verilog <<EOF
module big_counter(
    input clk,
    input rstn,
    input scd,
    input sce,
    output [15:0] out
);
    (* no_scan *) reg [1:0] delay;
    always @ (posedge clk or negedge rstn)
        if (!rstn)
            delay <= 2'b0;
        else
            delay <= {delay[0], 1'b1};
    wire rst_n_out = delay[1];

    wire[31:0] current;
    wire[31:0] next = current + 32'd1;
    
    (* blackbox *)
    sky130_fd_sc_hd__dfrtp_1 store[31:0] (
        .CLK(clk),
        .D(current),
        .Q(next),
        .RESET_B(rst_n_out),
    );
    
    assign out = current[15:0];
endmodule
EOF
hierarchy -top big_counter
opt_clean
proc
simplemap
dfflibmap -liberty tech/sky130_fd_sc_hd__tt_025C_1v80.lib 
scan_replace -json_mapping tech/sky130_mapping.json
write_verilog -noexpr -noattr out.v
